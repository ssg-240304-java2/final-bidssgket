<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{user/fragments/layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… ëª©ë¡</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.2/sockjs.min.js"></script>
    <link rel="stylesheet" href="/user/css/chat.css">
    <style>
        .my-message {
            background-color: #8D999E; /* ë³´ë‚¸ ì‚¬ëŒ ë§í’ì„  ìƒ‰ìƒ */
            text-align: right;
            padding: 10px;
            border-radius: 10px;
            margin: 5px 0;
            display: inline-block;
            max-width: 80%;
            align-self: flex-end;
        }

        .your-message {
            background-color: #FFFFFF; /* ë°›ì€ ì‚¬ëŒ ë§í’ì„  ìƒ‰ìƒ */
            text-align: left;
            padding: 10px;
            border-radius: 10px;
            margin: 5px 0;
            display: inline-block;
            max-width: 80%;
            align-self: flex-start;
        }

        .message-container {
            display: flex;
            justify-content: flex-end; /* ë³´ë‚¸ ì‚¬ëŒ ë©”ì‹œì§€ë¥¼ ì˜¤ë¥¸ìª½ì— ì •ë ¬ */
        }

        .your-message-container {
            justify-content: flex-start; /* ë°›ì€ ì‚¬ëŒ ë©”ì‹œì§€ë¥¼ ì™¼ìª½ì— ì •ë ¬ */
        }

        .chat-messages {
            padding: 10px;
            height: 400px;
            overflow-y: scroll;
        }
        .message-content-wrapper {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }

        .message-content {
            background-color: #F1F1F1;
            padding: 10px;
            border-radius: 10px;
            max-width: 80%;
        }

        .message-time {
            font-size: 10px;
            text-align: right;
            margin-top: 5px;
            color: #888888;
        }

        .member-name {
            font-size: 12px;
            text-align: left;
            margin-top: 5px;
            color: #555555;
            margin-bottom: 15px;
        }

        .your-message-container .member-name {
            text-align: right;
        }
    </style>
</head>
<body>
<main class="contents" layout:fragment="content">
    <div class="container mx-auto" style="max-width: 1440px;">
        <aside>
            <a href="/user/mypage" class="block">
                <h2 class="text-2xl font-bold mb-4 transform hover:scale-105 transition-transform duration-300">ë§ˆì´ í˜ì´ì§€</h2>
            </a>
            <ul class="space-y-2">
                <li>
                    <a href="/user/mypage" class="block text-left w-full text-gray-400 transform hover:scale-105 transition-transform duration-300">ì‡¼í•‘ ì •ë³´</a>
                </li>
                <li>
                    <a href="/user/order/purchases/history/auction" class="block text-left w-full text-gray-400 transform hover:scale-105 transition-transform duration-300">êµ¬ë§¤ ë‚´ì—­</a>
                </li>
                <li>
                    <a href="/user/order/sales/history/auction" class="block text-left w-full text-gray-400 transform hover:scale-105 transition-transform duration-300">íŒë§¤ ë‚´ì—­</a>
                </li>
                <li>
                    <a href="/user/payment/info" class="block text-left w-full text-gray-400 transform hover:scale-105 transition-transform duration-300">ê²°ì œ</a>
                </li>
                <li>
                    <a href="/chat" class="block text-left w-full  font-bold text-black transform hover:scale-105 transition-transform duration-300">ì±„íŒ…</a>
                </li>
            </ul>
        </aside>

        <div class="chat-container">
            <div class="chat-list">
                <ul id="chatroom-list">
                    <!--                    <li class="chat-item" data-chatroom="1" th:each="chatRoomMember : ${chatRoomMembers}">-->
                    <li class="chat-item" th:each="chatRoomMember : ${chatRoomMembers}" th:data-chatroom-no="${chatRoomMember.chatRoom.chatRoomNo}">
                        <div class="chat-info">
                            <!--                            <a th:href="@{|/chat/${chatRoomMember.chatRoomMemberNo}|}" >-->
                            <a href="#" class="chat-room-link">
                                <span class="chat-title" th:text="${chatRoomMember.chatRoom.name}"></span>
                            </a>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="chat-content">
                <div class="chat-header">
                    <span th:if="${chatRoomName == null}" id="chat-title">ì±„íŒ…ë°© ì„ íƒ</span>
                    <span th:if="${chatRoomName != null}" th:text="${chatRoomName}" id="chat-title"></span>
                </div>
                <div id="chat-messages" class="chat-messages">
                    <div th:each="message : ${messages}">
                        <div class="message-container" th:classappend="${message.member.memberNo == memberNo} ? '' : 'your-message-container'">
                            <div class="message" th:classappend="${message.member.memberNo == memberNo} ? 'my-message' : 'your-message'">
                                <div class="message-content" th:text="${message.message}"></div>
                                <div class="message-time" th:text="${#temporals.format(message.sentAt, 'yyyy.MM.dd HH:mm:ss')}"></div>
                            </div>
                        </div>
                        <div class="member-name" th:text="${message.member.name}"></div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    <button id="send-button">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        var stompClient = null;
        var memberNo = [[${memberNo}]]; // ì„œë²„ì—ì„œ ë°›ì€ memberNo ê°’ì„ ì‚¬ìš©
        var chatRoomNo = null; // í˜„ì¬ ì„ íƒëœ ì±„íŒ…ë°© ë²ˆí˜¸ë¥¼ ì €ì¥

        function connectAndSubscribe() {
            var socket = new SockJS('/ws-stomp');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);

                if (!chatRoomNo) {
                    console.error("Cannot subscribe to chat room because chatRoomNo is undefined.");
                    return;
                }

                // íŠ¹ì • ì±„íŒ…ë°©ì— ëŒ€í•œ êµ¬ë… ì„¤ì •
                stompClient.subscribe(`/pro/chatRoom/${chatRoomNo}`, function (messageOutput) {
                    const data = JSON.parse(messageOutput.body);
                    console.log("Received message: ", data); // ìˆ˜ì‹ ëœ ë©”ì‹œì§€ë¥¼ ì½˜ì†”ì— ì¶œë ¥
                    showChatMessage(data);  // ** ìƒˆë¡œìš´ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€ **
                    showNotification(data);
                });
            });
        }

        function sendChatMessage(chatMessage) {
            const message = {
                memberNo: memberNo,
                chatRoomNo: chatRoomNo,
                message: chatMessage
            };
            // ** WebSocketì„ í†µí•´ ë©”ì‹œì§€ë¥¼ ì„œë²„ë¡œ ì „ì†¡ **
            stompClient.send("/send/chat.sendMessage", {}, JSON.stringify(message));
            console.log('Chat message sent to server: ' + chatMessage);
        }

        // ** ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜ **
        function showChatMessage(chatMessage) {
            var messageClass = chatMessage.memberNo == memberNo ? 'my-message' : 'your-message';
            var messageContainerClass = chatMessage.memberNo == memberNo ? '' : 'your-message-container';

            // ì±„íŒ… ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€
            $("#chat-messages").append(
                "<div class='message-container " + messageContainerClass + "'>" +
                "<div class='message " + messageClass + "'>" + chatMessage.message +
                "</div></div>"
            );

            // ìŠ¤í¬ë¡¤ì„ ìµœì‹  ë©”ì‹œì§€ ìœ„ì¹˜ë¡œ ìë™ìœ¼ë¡œ ì´ë™
            $("#chat-messages").scrollTop($("#chat-messages")[0].scrollHeight);
        }

        // ** ì•Œë¦¼ì„ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ **
        function showNotification(chatMessage) {
            if (Notification.permission === "granted") {
                const notification = new Notification("ìƒˆë¡œìš´ ë©”ì„¸ì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤ğŸ“©", {
                    body: chatMessage.message,
                    icon: "/user/main/images/empty_heart2.png" // ì›í•˜ëŠ” ì•„ì´ì½˜ ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”
                });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        const notification = new Notification("ìƒˆë¡œìš´ ë©”ì„¸ì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤ğŸ“©", {
                            body: chatMessage.message,
                            icon: "/user/main/images/empty_heart2.png"
                        });
                    }
                });
            }
        }

        $(document).ready(function () {
            // ì±„íŒ…ë°© ì´ë¦„ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì±„íŒ…ë°©ì— ì ‘ì†
            $('.chat-room-link').on('click', function (event) {
                event.preventDefault();  // ê¸°ë³¸ í´ë¦­ ì´ë²¤íŠ¸(í˜ì´ì§€ ì´ë™)ë¥¼ ë°©ì§€

                var chatItem = $(this).closest('.chat-item'); // í´ë¦­ëœ ë§í¬ì˜ ë¶€ëª¨ ìš”ì†Œì—ì„œ ì±„íŒ…ë°© ì •ë³´ë¥¼ ê°€ì ¸ì˜´
                chatRoomNo = chatItem.data('chatroom-no');  // í´ë¦­ëœ ì±„íŒ…ë°© ë²ˆí˜¸ë¥¼ ê°€ì ¸ì˜´

                if (!chatRoomNo) {
                    console.error("Chat room number is undefined.");
                    return;
                }

                $("#chat-title").text($(this).find('.chat-title').text()); // ì±„íŒ…ë°© ì œëª©ì„ ì—…ë°ì´íŠ¸

                // jQueryë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì—ì„œ í•´ë‹¹ ì±„íŒ…ë°©ì˜ ê¸°ì¡´ ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜´
                $.ajax({
                    url: "/chat/messages",
                    type: "GET",
                    data: { chatRoomNo: chatRoomNo },
                    success: function(messages) {
                        console.log("Fetched messages:", messages); // ë°ì´í„° í™•ì¸ìš© ì½˜ì†” ë¡œê·¸

                        // ê¸°ì¡´ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œ
                        $("#chat-messages").html(messages.map(function(message) {
                            var messageClass = message.memberNo == memberNo ? 'my-message' : 'your-message';
                            var messageContainerClass = message.memberNo == memberNo ? '' : 'your-message-container';
                            return "<div class='message-container " + messageContainerClass + "'>" +
                                "<div class='message " + messageClass + "'>" + message.message +
                                "</div></div>";
                        }).join(''));

                        // ìŠ¤í¬ë¡¤ì„ ìµœì‹  ë©”ì‹œì§€ ìœ„ì¹˜ë¡œ ìë™ìœ¼ë¡œ ì´ë™
                        $("#chat-messages").scrollTop($("#chat-messages")[0].scrollHeight);
                    },
                    error: function(error) {
                        console.error("Error fetching chat messages:", error);
                        $("#chat-messages").html("<div class='error'>Failed to load messages. Please try again later.</div>");
                    }
                });

                connectAndSubscribe();  // WebSocketì„ í†µí•´ ì±„íŒ…ë°©ì— ì—°ê²° ë° ë©”ì‹œì§€ êµ¬ë… ì‹œì‘
            });

            // ë©”ì‹œì§€ ì „ì†¡ ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ì‹œì§€ ì „ì†¡
            $('#send-button').on('click', function () {
                var chatMessage = $('#message-input').val(); // ì…ë ¥ëœ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
                if (chatMessage && chatRoomNo) { // ë©”ì‹œì§€ì™€ ì±„íŒ…ë°©ì´ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                    sendChatMessage(chatMessage); // ** ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡ **
                    $('#message-input').val('');  // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                }
            });

            // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡ ì²˜ë¦¬
            $('#message-input').on('keyup', function (event) {
                if (event.key === 'Enter' && !event.shiftKey) { // Shift+Enterê°€ ì•„ë‹Œ ê²½ìš°
                    event.preventDefault(); // ê¸°ë³¸ Enter ë™ì‘(ì¤„ë°”ê¿ˆ) ë°©ì§€

                    var chatMessage = $('#message-input').val().trim(); // ë©”ì‹œì§€ ì…ë ¥ í•„ë“œì˜ ê°’ì„ ê°€ì ¸ì˜¤ê³  ê³µë°± ì œê±°
                    if (chatMessage !== '') { // ë©”ì‹œì§€ê°€ ë¹„ì–´ ìˆì§€ ì•Šì„ ë•Œë§Œ ì „ì†¡
                        sendChatMessage(chatMessage); // ** ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡ **
                        $('#message-input').val('');  // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                    }
                }
            });

            // ** ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ **
            if (Notification.permission !== "granted") {
                Notification.requestPermission().then(permission => {
                    if (permission !== "granted") {
                        console.log("Notification permission denied.");
                    }
                });
            }
        });
    </script>
</main>
</body>
</html>