<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{user/fragments/layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… ëª©ë¡</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.2/sockjs.min.js"></script>
    <link rel="stylesheet" href="/user/member/chat.css">
    <style>
    .container {
    display: flex;
    max-width: 1440px;
    margin: 0 auto;
    }

    aside {
    width: 20%;
    min-width: 200px;
    }

    .chat-container {
    display: flex;
    flex: 1;
    padding-left: 20px;
    }

    .chat-list {
    width: 30%;
    background-color: #f9f9f9;
    padding: 10px;
    border-right: 1px solid #ddd;
    overflow-y: auto;
    }

    .chat-content {
    flex: 1;
    padding: 10px;
    background-color: #fff;
    overflow-y: auto;
    }

    .chat-item {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
    transition: background-color 0.2s;
    }

    .chat-item:hover {
    background-color: #f0f0f0;
    }

    .chat-item .chat-title {
    font-size: 16px;
    font-weight: bold;
    }

    .chat-header {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 10px;
    }

    .chat-messages {
    height: 400px;
    overflow-y: scroll;
    padding: 10px;
    }

    .chat-input {
    display: flex;
    align-items: center;
    margin-top: 10px;
    }

    .chat-input input[type="text"] {
    flex: 1;
    padding: 10px;
    margin-right: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    }

    .chat-input button {
    padding: 10px;
    border: none;
    background-color: #007bff;
    color: #fff;
    border-radius: 4px;
    cursor: pointer;
    }

    .chat-input button:hover {
    background-color: #0056b3;
    }
    </style>
</head>
<body>
<main class="contents" layout:fragment="content">
    <div class="container mx-auto">
        <aside>
            <a href="/user/mypage" class="block">
                <h2 class="text-2xl font-bold mb-4 transform hover:scale-105 transition-transform duration-300">ë§ˆì´ í˜ì´ì§€</h2>
            </a>
            <ul class="space-y-2">
                <li>
                    <a href="/user/mypage" class="block text-left w-full font-bold text-black transform hover:scale-105 transition-transform duration-300">ì‡¼í•‘ ì •ë³´</a>
                </li>
                <li>
                    <a href="/user/order/purchases/history/auction" class="block text-left w-full text-gray-400 transform hover:scale-105 transition-transform duration-300">êµ¬ë§¤ ë‚´ì—­</a>
                </li>
                <li>
                    <a href="/user/order/sales/history/auction" class="block text-left w-full text-gray-400 transform hover:scale-105 transition-transform duration-300">íŒë§¤ ë‚´ì—­</a>
                </li>
                <li>
                    <a href="/user/payment/info" class="block text-left w-full text-gray-400 transform hover:scale-105 transition-transform duration-300">ê²°ì œ</a>
                </li>
                <li>
                    <a href="/chat" class="block text-left w-full text-gray-400 transform hover:scale-105 transition-transform duration-300">ì±„íŒ…</a>
                </li>
            </ul>
        </aside>

        <div class="chat-container">
            <div class="chat-list">
                <ul id="chatroom-list">
<!--                    <li class="chat-item" data-chatroom="1" th:each="chatRoomMember : ${chatRoomMembers}">-->
                    <li class="chat-item" th:each="chatRoomMember : ${chatRoomMembers}" th:data-chatroom-no="${chatRoomMember.chatRoom.chatRoomNo}">
                        <div class="chat-info">
<!--                            <a th:href="@{|/chat/${chatRoomMember.chatRoomMemberNo}|}" >-->
                            <a href="#" class="chat-room-link">
                                <span class="chat-title" th:text="${chatRoomMember.chatRoom.name}"></span>
                            </a>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="chat-content">
                <div class="chat-header">
                    <span th:if="${chatRoomName == null}" id="chat-title">ì±„íŒ…ë°© ì„ íƒ</span>
                    <span th:if="${chatRoomName != null}" th:text="${chatRoomName}" id="chat-title"></span>
                </div>
                <div id="chat-messages" class="chat-messages">
                    <div th:each="message : ${messages}">
                        <div class="message-container" th:classappend="${message.member.memberNo == memberNo} ? '' : 'your-message-container'">
                        <div class="message" th:classappend="${message.member.memberNo == memberNo} ? 'my-messages' : 'your-message'">
                            <div class="message-content" th:text="${message.message}"></div>
                            <div class="message-time" th:text="${#temporals.format(T(java.time.LocalDateTime).parse(message.sentAt), 'HH:mm')}"></div>
                        </div>
                        </div>
                        <div class="member-name" th:text="${message.member.name}"></div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="file" id="image-input" accept="image/*" style="display: none;">
                    <button id="image-upload-button"><i class="fas fa-image"></i></button>
                    <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    <button id="send-button">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        var stompClient = null;
        var memberNo = [[${memberNo}]]; // ì„œë²„ì—ì„œ ë°›ì€ memberNo ê°’ì„ ì‚¬ìš©
        var chatRoomNo = null; // í˜„ì¬ ì„ íƒëœ ì±„íŒ…ë°© ë²ˆí˜¸ë¥¼ ì €ì¥

        function connectAndSubscribe() {
            var socket = new SockJS('/ws-stomp');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);

                if (!chatRoomNo) {
                    console.error("Cannot subscribe to chat room because chatRoomNo is undefined.");
                    return;
                }

                // íŠ¹ì • ì±„íŒ…ë°©ì— ëŒ€í•œ êµ¬ë… ì„¤ì •
                stompClient.subscribe(`/pro/chatRoom/${chatRoomNo}`, function (messageOutput) {
                    const data = JSON.parse(messageOutput.body);
                    console.log("Received message: ", data); // ìˆ˜ì‹ ëœ ë©”ì‹œì§€ë¥¼ ì½˜ì†”ì— ì¶œë ¥
                    showChatMessage(data);  // ** ìƒˆë¡œìš´ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€ **
                    showNotification(data);
                });
            });
        }

        function sendChatMessage(chatMessage) {
            const message = {
                memberNo: memberNo,
                chatRoomNo: chatRoomNo,
                message: chatMessage
            };
            // ** WebSocketì„ í†µí•´ ë©”ì‹œì§€ë¥¼ ì„œë²„ë¡œ ì „ì†¡ **
            stompClient.send("/send/chat.sendMessage", {}, JSON.stringify(message));
            console.log('Chat message sent to server: ' + chatMessage);
        }

        // ** ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜ **
        function showChatMessage(chatMessage) {
            var messageClass = chatMessage.memberNo == memberNo ? 'my-messages' : 'your-message';
            var messageContainerClass = chatMessage.memberNo == memberNo ? '' : 'your-message-container';

            var messageContent;
            if (chatMessage.message) {
                // ë©”ì‹œì§€ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°, í…ìŠ¤íŠ¸ë¡œë§Œ í‘œì‹œ
                messageContent = chatMessage.message;
            } else if (chatMessage.imageUrl) {
                // ë©”ì‹œì§€ê°€ ì—†ê³  ì´ë¯¸ì§€ URLì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì´ë¯¸ì§€ë¥¼ í‘œì‹œ
                messageContent = "<img src='" + chatMessage.imageUrl + "' alt='ì´ë¯¸ì§€' style='max-width: 100%;'>";
            }

            // sentAtì„ JavaScript Date ê°ì²´ë¡œ ë³€í™˜í•˜ê³  ì‹œê°„ í¬ë§· ì ìš©
            var sentAt = new Date(chatMessage.sentAt);
            var hours = sentAt.getHours().toString().padStart(2, '0');
            var minutes = sentAt.getMinutes().toString().padStart(2, '0');
            var formattedTime = hours + ':' + minutes;

            // ì±„íŒ… ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€
            $("#chat-messages").append(
                "<div class='message-container " + messageContainerClass + "'>" +
                "<div class='message " + messageClass + "'>" + messageContent +
                "<div class='message-time'>" + formattedTime + "</div>" +  // ì‹œê°„ì„ ì¶”ê°€í•˜ì—¬ í‘œì‹œ
                "</div></div>"
            );


            // ìŠ¤í¬ë¡¤ì„ ìµœì‹  ë©”ì‹œì§€ ìœ„ì¹˜ë¡œ ìë™ìœ¼ë¡œ ì´ë™
            $("#chat-messages").scrollTop($("#chat-messages")[0].scrollHeight);
        }

        // ** ì•Œë¦¼ì„ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ **
        function showNotification(chatMessage) {
            // í˜„ì¬ ì‚¬ìš©ìì˜ memberNoì™€ ë©”ì‹œì§€ì˜ ë°œì‹ ì memberNoë¥¼ ë¹„êµ
            if (chatMessage.memberNo !== memberNo) {
                // ë©”ì‹œì§€ê°€ ìƒëŒ€ë°©ìœ¼ë¡œë¶€í„° ì˜¨ ê²½ìš°ì—ë§Œ ì•Œë¦¼ í‘œì‹œ
                if (Notification.permission === "granted") {
                    const notification = new Notification("ìƒˆë¡œìš´ ë©”ì„¸ì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤ğŸ“©", {
                        body: chatMessage.message ? chatMessage.message : "ì´ë¯¸ì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤ğŸ“·", // ì´ë¯¸ì§€ì¸ ê²½ìš° ë©”ì‹œì§€ê°€ ì—†ì„ ìˆ˜ ìˆìŒ
                        icon: "/user/main/images/empty_heart2.png" // ì›í•˜ëŠ” ì•„ì´ì½˜ ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”
                    });
                } else if (Notification.permission !== "denied") {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            const notification = new Notification("ìƒˆë¡œìš´ ë©”ì„¸ì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤ğŸ“©", {
                                body: chatMessage.message ? chatMessage.message : "ì´ë¯¸ì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤ğŸ“·",
                                icon: "/user/main/images/empty_heart2.png"
                            });
                        }
                    });
                }
            }
        }

        $(document).ready(function () {
            // ì±„íŒ…ë°© ì´ë¦„ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì±„íŒ…ë°©ì— ì ‘ì†
            $('.chat-room-link').on('click', function (event) {
                event.preventDefault();  // ê¸°ë³¸ í´ë¦­ ì´ë²¤íŠ¸(í˜ì´ì§€ ì´ë™)ë¥¼ ë°©ì§€

                var chatItem = $(this).closest('.chat-item'); // í´ë¦­ëœ ë§í¬ì˜ ë¶€ëª¨ ìš”ì†Œì—ì„œ ì±„íŒ…ë°© ì •ë³´ë¥¼ ê°€ì ¸ì˜´
                chatRoomNo = chatItem.data('chatroom-no');  // í´ë¦­ëœ ì±„íŒ…ë°© ë²ˆí˜¸ë¥¼ ê°€ì ¸ì˜´

                if (!chatRoomNo) {
                    console.error("Chat room number is undefined.");
                    return;
                }

                $("#chat-title").text($(this).find('.chat-title').text()); // ì±„íŒ…ë°© ì œëª©ì„ ì—…ë°ì´íŠ¸

                // jQueryë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì—ì„œ í•´ë‹¹ ì±„íŒ…ë°©ì˜ ê¸°ì¡´ ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜´
                $.ajax({
                    url: "/chat/messages",
                    type: "GET",
                    data: { chatRoomNo: chatRoomNo },
                    success: function(messages) {
                        console.log("Fetched messages:", messages); // ë°ì´í„° í™•ì¸ìš© ì½˜ì†” ë¡œê·¸

                        // ê¸°ì¡´ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œ
                        $("#chat-messages").html(messages.map(function(message) {
                            var messageClass = message.memberNo == memberNo ? 'my-messages' : 'your-message';
                            var messageContainerClass = message.memberNo == memberNo ? '' : 'your-message-container';

                            var messageContent;
                            if (message.message) {
                                // ë©”ì‹œì§€ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°, í…ìŠ¤íŠ¸ë¡œë§Œ í‘œì‹œ
                                messageContent = message.message;
                            } else if (message.imageUrl) {
                                // ë©”ì‹œì§€ê°€ ì—†ê³  ì´ë¯¸ì§€ URLì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì´ë¯¸ì§€ë¥¼ í‘œì‹œ
                                messageContent = "<img src='" + message.imageUrl + "' alt='ì´ë¯¸ì§€' style='max-width: 100%;'>";
                            }

                            // sentAtì„ JavaScript Date ê°ì²´ë¡œ ë³€í™˜í•˜ê³  ì‹œê°„ í¬ë§· ì ìš©
                            var sentAt = new Date(message.sentAt);
                            var hours = sentAt.getHours().toString().padStart(2, '0');
                            var minutes = sentAt.getMinutes().toString().padStart(2, '0');
                            var formattedTime = hours + ':' + minutes;

                            return "<div class='message-container " + messageContainerClass + "'>" +
                                "<div class='message " + messageClass + "'>" + messageContent +
                                "</div>" +
                                "<div class='message-time'>" + formattedTime + "</div>" + // ì‹œê°„ í‘œì‹œë¥¼ ë©”ì‹œì§€ ì™¸ë¶€ë¡œ ì´ë™
                                "</div>";
                        }).join(''));
                        // ìŠ¤í¬ë¡¤ì„ ìµœì‹  ë©”ì‹œì§€ ìœ„ì¹˜ë¡œ ìë™ìœ¼ë¡œ ì´ë™
                        $("#chat-messages").scrollTop($("#chat-messages")[0].scrollHeight);
                    },
                    error: function(error) {
                        console.error("Error fetching chat messages:", error);
                        $("#chat-messages").html("<div class='error'>Failed to load messages. Please try again later.</div>");
                    }
                });

                connectAndSubscribe();  // WebSocketì„ í†µí•´ ì±„íŒ…ë°©ì— ì—°ê²° ë° ë©”ì‹œì§€ êµ¬ë… ì‹œì‘
            });

            // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ ì°½ ì—´ê¸°
            $('#image-upload-button').on('click', function () {
                $('#image-input').click();
            });

            // ì´ë¯¸ì§€ íŒŒì¼ì´ ì„ íƒë˜ë©´ ì„œë²„ì— ì—…ë¡œë“œ
            $('#image-input').on('change', function () {
                var file = this.files[0];
                if (file && chatRoomNo) {
                    var formData = new FormData();
                    formData.append('file', file);
                    formData.append('chatRoomNo',chatRoomNo);

                    $.ajax({
                        url: '/chat/upload',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (responseDto) {
                            console.log("Image upload successful, message will be handled by WebSocket.");
                        },
                        error: function (error) {
                            console.error("Image upload failed:", error);
                        }
                    });
                }
            });


            // ë©”ì‹œì§€ ì „ì†¡ ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ì‹œì§€ ì „ì†¡
            $('#send-button').on('click', function () {
                var chatMessage = $('#message-input').val(); // ì…ë ¥ëœ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
                if (chatMessage && chatRoomNo) { // ë©”ì‹œì§€ì™€ ì±„íŒ…ë°©ì´ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                    sendChatMessage(chatMessage); // ** ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡ **
                    $('#message-input').val('');  // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                }
            });

            // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡ ì²˜ë¦¬
            $('#message-input').on('keyup', function (event) {
                if (event.key === 'Enter' && !event.shiftKey) { // Shift+Enterê°€ ì•„ë‹Œ ê²½ìš°
                    event.preventDefault(); // ê¸°ë³¸ Enter ë™ì‘(ì¤„ë°”ê¿ˆ) ë°©ì§€

                    var chatMessage = $('#message-input').val().trim(); // ë©”ì‹œì§€ ì…ë ¥ í•„ë“œì˜ ê°’ì„ ê°€ì ¸ì˜¤ê³  ê³µë°± ì œê±°
                    if (chatMessage !== '') { // ë©”ì‹œì§€ê°€ ë¹„ì–´ ìˆì§€ ì•Šì„ ë•Œë§Œ ì „ì†¡
                        sendChatMessage(chatMessage); // ** ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡ **
                        $('#message-input').val('');  // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                    }
                }
            });

            // ** ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ **
            if (Notification.permission !== "granted") {
                Notification.requestPermission().then(permission => {
                    if (permission !== "granted") {
                        console.log("Notification permission denied.");
                    }
                });
            }
        });


    </script>
</main>
</body>
</html>